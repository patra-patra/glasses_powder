<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Каталог товаров — Очки и Пудра</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='menu_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='product-cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='category_page/empty_category_page.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/sign.png') }}">
</head>
<body>
    {% include 'header.html' %}

    <main class="category-main">
        <div class="container">
            <div class="category-layout">
                <!-- Левая колонка с фильтрами -->
                <aside class="filter-sidebar">
                    <h3>Фильтры</h3>

                    <form method="GET" action="{{ url_for('catalog') }}">
                        <input type="hidden" name="type" value="{{ current_type }}">
                        <div class="filter-group">
                            <h4>Бренд</h4>
                            <div class="filter-options brand-scroll">
                                {% for brand in brands %}
                                    <label class="filter-checkbox">
                                        <input type="checkbox" name="brand" value="{{ brand }}"
                                               {% if brand in selected_brands %}checked{% endif %}>
                                        <span>{{ brand }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="filter-group">
                            <h4>Цена</h4>
                            <div class="price-slider">
                                <div class="price-inputs">
                                    <input type="text" name="min_price" placeholder="от" value="{{ min_price or '' }}" class="price-input">
                                    <span>—</span>
                                    <input type="text" name="max_price" placeholder="до" value="{{ max_price or '' }}" class="price-input">
                                </div>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label for="country-select">Страна производства:</label>
                            <select id="country-select" name="country" onchange="this.form.submit()">
                                <option value="">Все</option>
                                {% for country in countries %}
                                    <option value="{{ country }}" {% if selected_country == country %}selected{% endif %}>
                                        {{ country }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="filter-btn">Применить</button>
                        <a href="{{ url_for('catalog') }}" class="btn btn-primary reset-filters">Сбросить фильтры</a>
                    </form>
                </aside>



                <!-- Правая колонка с содержимым -->
                <div class="products-content">
                    <!-- Поисковая строка -->
                    <div class="search-block-category">
                        <form class="search-form" id="search-form" method="GET" action="{{ url_for('catalog') }}">
                            <input type="text" name="q" id="search-input" placeholder="Поиск товаров..." class="search-input" autocomplete="off" value="{{ request.args.get('q', '') }}">
                            <!-- Сохраняем другие параметры как скрытые поля -->
                            <input type="hidden" name="type" value="{{ request.args.get('type', '') }}">
                            <input type="hidden" name="sort" value="{{ request.args.get('sort', 'popularity') }}">
                            <input type="hidden" name="order" value="{{ request.args.get('order', 'desc') }}">
                            <button type="submit" class="search-button">
                                <i class="fas fa-search"></i>
                            </button>
                        </form>

                    </div>



                    <!-- Сортировка -->
                    <div class="sort-block">
                        <span>Сортировать:</span>
                        <div class="sort-options">
                            <button class="sort-btn {% if request.args.get('sort', 'popularity') == 'popularity' %}active{% endif %}" data-sort="popularity" data-order="desc">По популярности</button>
                            <button class="sort-btn {% if request.args.get('sort') == 'price' and request.args.get('order') == 'asc' %}active{% endif %}" data-sort="price" data-order="asc">По цене ↑</button>
                            <button class="sort-btn {% if request.args.get('sort') == 'price' and request.args.get('order') == 'desc' %}active{% endif %}" data-sort="price" data-order="desc">По цене ↓</button>
                            <button class="sort-btn {% if request.args.get('sort') == 'new' %}active{% endif %}" data-sort="new" data-order="desc">По новизне</button>
                        </div>
                    </div>


                    <div id="product-results">
                        <div class="product-grid">
                            {% for product in products.items %}
                                <div class="product-card" data-category="{{ product.category }}">
                                    <div class="product-image">
                                        <img src="{{ url_for('static', filename='img/products/' ~ product.photonum) }}" alt="{{ product.name }}">
                                        <div class="product-badges">
                                            {% if loop.index == 1 %}
                                                <span class="product-badge">Новинка</span>
                                            {% elif loop.index == 2 %}
                                                <span class="product-badge">Хит</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="product-info">
                                        <h3>{{ product.name }}</h3>
                                        {% if product.desc != 'no' %}
                                            <p>{{ product.desc[:120] }}{% if product.desc|length > 120 %}...{% endif %}</p>
                                        {% endif %}
                                        <div class="product-bottom">
                                            <div class="product-price">{{ '{:,.0f}'.format(product.price | int).replace(',', ' ') }} ₽</div>
                                            <form action="{{ url_for('add_to_cart') }}" method="POST">
                                              <input type="hidden" name="product_id" value="{{ product.id }}">
                                              <button type="submit">В корзину</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>



                    <div class="pagination">
                        {% if products.has_prev %}
                            <a href="{{ url_for('catalog', page=products.prev_num, type=current_type, brand=selected_brands, country=selected_country, min_price=min_price, max_price=max_price, sort=request.args.get('sort'), order=request.args.get('order')) }}">&laquo;</a>
                        {% endif %}

                        {% for p in range(1, products.pages + 1) %}
                            <a href="{{ url_for('catalog', page=p, type=current_type, brand=selected_brands, country=selected_country, min_price=min_price, max_price=max_price, sort=request.args.get('sort'), order=request.args.get('order')) }}" class="{% if p == products.page %}active{% endif %}">
                                {{ p }}
                            </a>
                        {% endfor %}

                        {% if products.has_next %}
                            <a href="{{ url_for('catalog', page=products.next_num, type=current_type, brand=selected_brands, country=selected_country, min_price=min_price, max_price=max_price, sort=request.args.get('sort'), order=request.args.get('order')) }}">&raquo;</a>
                        {% endif %}
                    </div>



                </div>
            </div>
        </div>
    </main>

        {% include 'partials/footer.html' %}

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const searchInput = document.getElementById("search-input");
        const productResults = document.getElementById("product-results");

        let timer = null;

        searchInput.addEventListener("input", function() {
            clearTimeout(timer);
            timer = setTimeout(() => {
                const query = searchInput.value;

                fetch(`/search?q=${encodeURIComponent(query)}`)
                    .then(response => response.text())
                    .then(html => {
                        productResults.innerHTML = html;
                    });
            }, 300); // задержка для избежания спама-запросов
        });
    });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const sortButtons = document.querySelectorAll(".sort-btn");
        const productResults = document.getElementById("product-results");

        sortButtons.forEach(button => {
            button.addEventListener("click", function () {
                sortButtons.forEach(btn => btn.classList.remove("active"));
                this.classList.add("active");

                const sort = this.dataset.sort;
                const order = this.dataset.order;

                const query = new URLSearchParams({
                    sort,
                    order,
                    q: document.getElementById("search-input")?.value || ''
                });

                fetch(`/search?${query.toString()}`)
                    .then(res => res.text())
                    .then(html => {
                        productResults.innerHTML = html;
                    });
            });
        });
    });
    </script>

    <script>
    document.querySelectorAll('.sort-btn').forEach(button => {
        button.addEventListener('click', () => {
            const urlParams = new URLSearchParams(window.location.search);

            urlParams.set('sort', button.getAttribute('data-sort'));
            urlParams.set('order', button.getAttribute('data-order'));
            urlParams.set('page', 1); // при изменении сортировки возвращаемся на первую страницу

            // Оставляем остальные параметры (type, q, brand и т.д.) как есть

            // Перенаправляем
            window.location.search = urlParams.toString();
        });
    });
    </script>

    <script>
    function onCountryChange() {
        const select = document.getElementById('country-select');
        const urlParams = new URLSearchParams(window.location.search);

        if(select.value) {
            urlParams.set('country', select.value);
        } else {
            urlParams.delete('country');
        }
        urlParams.set('page', 1); // сбрасываем пагинацию при фильтре
        window.location.search = urlParams.toString();
    }
    </script>

    <script>
    document.addEventListener("click", function (e) {
        if (e.target.classList.contains("btn-outline")) {
            const button = e.target;
            const id = button.dataset.id;
            const title = button.dataset.title;
            const price = parseFloat(button.dataset.price);

            const cart = JSON.parse(localStorage.getItem("beautyVisionCart")) || {};

            if (cart[id]) {
                cart[id].quantity += 1;
            } else {
                cart[id] = { id, title, price, quantity: 1 };
            }

            localStorage.setItem("beautyVisionCart", JSON.stringify(cart));
            alert(`Товар "${title}" добавлен в корзину`);
        }
    });

    </script>

</body>
</html>