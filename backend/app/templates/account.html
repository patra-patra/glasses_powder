<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет | Очки & Пудра</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='account/account.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='menu_style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/sign.png') }}">
</head>
<body>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

    {% include 'header.html' %}

    <main class="account-main">
        <div class="container">
            <div class="account-header">
                <span class="section-tag">Личный кабинет</span>
                <p>Добро пожаловать, <span class="data-value">{{ user.first_name }}</span> !</p>
            </div>

            <div class="account-wrapper">
                <aside class="account-sidebar">
                    <div class="user-info">
                        <div class="user-avatar">
                            <img src="{{ url_for('static', filename='img/portrait/katya.jpg') }}" alt="Аватар пользователя">
                        </div>
                        <h3>{{ user.first_name }} {{ user.last_name }}</h3>
                        <p class="user-status">Постоянный клиент</p>
                    </div>

                    <nav class="account-nav">
                        <ul>
                            <li class="active">
                                <a href="#profile" data-tab="profile">
                                    <i class="fas fa-user-circle"></i> Профиль
                                </a>
                            </li>
                            <li>
                                <a href="#orders" data-tab="orders">
                                    <i class="fas fa-shopping-bag"></i> Мои заказы
                                    <span class="badge">2</span>
                                </a>
                            </li>
                            <!--<li>
                                <a href="#favorites" data-tab="favorites">
                                    <i class="fas fa-heart"></i> Избранное
                                </a>
                            </li>-->
                            <li>
                                <a href="#addresses" data-tab="addresses">
                                    <i class="fas fa-map-marker-alt"></i> Адреса доставки
                                </a>
                            </li>
                            <!--<li>
                                <a href="#settings" data-tab="settings">
                                    <i class="fas fa-cog"></i> Настройки
                                </a>
                            </li>-->
                            <li class="logout">
                                <a href="{{ url_for('logout') }}">
                                    <i class="fas fa-sign-out-alt"></i> Выйти
                                </a>
                            </li>
                        </ul>
                    </nav>
                </aside>
            <div class="account-content">
                <!-- Профиль -->
                <div class="tab-content active" id="profile">
                    <div class="section-card">
                        <div class="section-header">
                            <h3>Личные данные</h3>
                            <button class="edit-btn" data-form="personal-form">
                                <i class="fas fa-pen"></i> Редактировать
                            </button>
                        </div>
                        <div class="personal-info">
                            <div class="profile-data">
                                <div class="data-row">
                                    <span class="data-label">Имя:</span>
                                    <span class="data-value">{{ user.first_name }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Фамилия:</span>
                                    <span class="data-value">{{ user.last_name }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Телефон:</span>
                                    <span class="data-value">{{ user.phone }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Дата рождения:</span>
                                    <span class="data-value">{{ user.birthdate }}</span>
                                </div>
                            </div>
                            <form class="profile-form hidden" id="personal-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="firstname">Имя</label>
                                        <input type="text" id="firstname" value="{{ user.first_name }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="lastname">Фамилия</label>
                                        <input type="text" id="lastname" value="{{ user.last_name }}">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Телефон</label>
                                    <input type="tel" id="phone" value="{{ user.phone }}">
                                </div>
                                <div class="form-group">
                                    <label for="birthdate">Дата рождения</label>
                                    <input type="date" id="birthdate" value="{{ user.birthdate}}">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary">Сохранить</button>
                                    <button type="button" class="btn-secondary cancel-btn" data-form="personal-form">Отмена</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header">
                            <h3>Изменить пароль</h3>
                        </div>
                        <form class="password-form" id="change-password-form">
                            <div class="form-group">
                                <label for="current-password">Текущий пароль</label>
                                <input type="password" id="current-password" required>
                            </div>
                            <div class="form-group">
                                <label for="new-password">Новый пароль</label>
                                <input type="password" id="new-password" required>
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Подтвердите пароль</label>
                                <input type="password" id="confirm-password" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Изменить пароль</button>
                            </div>
                            <div id="password-message" class="error-message"></div>
                        </form>
                    </div>
                </div>
                <!-- Мои заказы -->
                <div class="tab-content" id="orders">
                    <div class="section-card">
                        <div class="section-header">
                            <h3>История заказов</h3>
                        </div>
                        <div class="orders-list">
                            {% for order in orders %}
                                <div class="order-item">
                                    <div class="order-header">
                                        <div class="order-info">
                                            <div class="order-number">Заказ №{{ order.id }}</div>
                                            <div class="order-date">{{ order.created_at.strftime('%d.%m.%Y') }}</div>
                                        </div>
                                        <div class="order-status {{ 'completed' if order.status == 'доставлен' else 'processing' }}">
                                            <span>{{ order.status.capitalize() }}</span>
                                        </div>
                                        <div class="order-price">
                                            {% set total_price = 0 %}
                                            {% for item in order.items %}
                                                {% set item_price = item.price or 0 %}
                                                {% set item_qty = item.quantity or 0 %}
                                                {% set total_price = total_price + (item_price * item_qty) %}
                                            {% endfor %}


                                            <div class="order-price">{{ total_price }} ₽</div>

                                        </div>
                                    </div>

                                    <div class="order-products">
                                        {% for item in order.items %}
                                            <div class="order-product">
                                                <img src="{% if item.product.url %}
                                                            {{ item.product.url }}
                                                          {% else %}
                                                            {{ url_for('static', filename='img/products/' ~ item.product.photonum) }}
                                                          {% endif %}"
                                                     alt="{{ item.product.name }}">
                                                <div class="product-details">
                                                    <h4>{{ item.product.name }}</h4>
                                                    {% if item.product.desc != 'no' %}
                                                        <p>{{ item.product.desc[:120] }}{% if item.product.desc|length > 120 %}...{% endif %}</p>
                                                    {% endif %}
                                                    <div class="product-qty">Количество: {{ item.quantity }}</div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>


                                    <div class="order-actions">
                                        <form method="post" action="{{ url_for('repeat_order', order_id=order.id) }}">
                                            <button type="submit" class="btn-primary">Повторить заказ</button>
                                        </form>

                                    </div>
                                </div>
                            {% else %}
                                <p>У вас пока нет заказов.</p>
                            {% endfor %}
                        </div>

                    </div>
                </div>

                <!-- Избранное -->

                    <!-- Адреса -->
                    <div class="tab-content" id="addresses">
                        <div class="section-card">
                            <div class="section-header">
                                <h3>Мой адрес</h3>
                            </div>
                            <div class="address-list">

                              {% for address in addresses %}
                              <div class="address-item">
                                <p><strong>Дом:</strong> {{ address.street }}</p>
                                <p><strong>Город:</strong> {{ address.city }}</p>
                                <p><strong>Индекс:</strong> {{ address.postal_code }}</p>
                              </div>
                              {% endfor %}
                            </div>
                        </div>
                    </div>
                </div> <!-- .account-content -->
            </div> <!-- .account-wrapper -->
        </div> <!-- .container -->
    </main>

    {% include 'partials/footer.html' %}


    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="{{ url_for('static', filename='account/account.js') }}"></script>
</body>
</html>

