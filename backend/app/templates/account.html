<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет | Очки & Пудра</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='account/account.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='menu_style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/sign.svg') }}">
</head>
<body>
    {% include 'header.html' %}

    <main class="account-main">
        <div class="container">
            <div class="account-header">
                <span class="section-tag">Личный кабинет</span>
                <p>Добро пожаловать, <span class="data-value">{{ user.first_name }}</span> !</p>
            </div>

            <div class="account-wrapper">
                <aside class="account-sidebar">
                    <div class="user-info">
                        <div class="user-avatar">
                            <img src="{{ url_for('static', filename='img/portrait/katya.jpg') }}" alt="Аватар пользователя">
                        </div>
                        <h3>{{ user.first_name }} {{ user.last_name }}</h3>
                        <p class="user-status">Постоянный клиент</p>
                    </div>

                    <nav class="account-nav">
                        <ul>
                            <li class="active">
                                <a href="#profile" data-tab="profile">
                                    <i class="fas fa-user-circle"></i> Профиль
                                </a>
                            </li>
                            <li>
                                <a href="#orders" data-tab="orders">
                                    <i class="fas fa-shopping-bag"></i> Мои заказы
                                    {% if orders|length > 0 %}
                                        <span class="badge">{{ orders|length }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li>
                                <a href="#addresses" data-tab="addresses">
                                    <i class="fas fa-map-marker-alt"></i> Адреса доставки
                                </a>
                            </li>
                            <li>
                                <a href="#settings" data-tab="settings">
                                    <i class="fas fa-cog"></i> Настройки
                                </a>
                            </li>
                            <li class="logout">
                                <a href="{{ url_for('logout') }}">
                                    <i class="fas fa-sign-out-alt"></i> Выйти
                                </a>
                            </li>
                        </ul>
                    </nav>
                </aside>
            <div class="account-content">
                <!-- Профиль -->
                <div class="tab-content active" id="profile">
                    <div class="section-card">
                        <div class="section-header">
                            <h3>Личные данные</h3>
                            <button class="edit-btn" data-form="personal-form">
                                <i class="fas fa-pen"></i> Редактировать
                            </button>
                        </div>
                        <div class="personal-info">
                            <div class="profile-data">
                                <div class="data-row">
                                    <span class="data-label">Имя:</span>
                                    <span class="data-value">{{ user.first_name }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Фамилия:</span>
                                    <span class="data-value">{{ user.last_name }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Телефон:</span>
                                    <span class="data-value">{{ user.phone }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Дата рождения:</span>
                                    <span class="data-value">{{ user.birthdate }}</span>
                                </div>
                            </div>
                            <form class="profile-form hidden" id="personal-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="firstname">Имя</label>
                                        <input type="text" id="firstname" value="{{ user.first_name }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="lastname">Фамилия</label>
                                        <input type="text" id="lastname" value="{{ user.last_name }}">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Телефон</label>
                                    <input type="tel" id="phone" value="{{ user.phone }}">
                                </div>
                                <div class="form-group">
                                    <label for="birthdate">Дата рождения</label>
                                    <input type="date" id="birthdate" value="{{ user.birthdate}}">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary">Сохранить</button>
                                    <button type="button" class="btn-secondary cancel-btn" data-form="personal-form">Отмена</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header">
                            <h3>Изменить пароль</h3>
                        </div>
                        <form class="password-form" id="change-password-form">
                            <div class="form-group">
                                <label for="current-password">Текущий пароль</label>
                                <input type="password" id="current-password" required>
                            </div>
                            <div class="form-group">
                                <label for="new-password">Новый пароль</label>
                                <input type="password" id="new-password" required>
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Подтвердите пароль</label>
                                <input type="password" id="confirm-password" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Изменить пароль</button>
                            </div>
                            <div id="password-message" class="error-message"></div>
                        </form>
                    </div>
                </div>
                <!-- Мои заказы -->
                <div class="tab-content" id="orders">
                    <div class="section-card">
                        <div class="section-header">
                            <h3>История заказов</h3>
                        </div>
                        <div class="orders-list">
                            {% for order in orders %}
                                <div class="order-item">
                                    <div class="order-header">
                                        <div class="order-info">
                                            <div class="order-number">Заказ №{{ order.id }}</div>
                                                <div class="order-date">Дата заказа: {{ order.created_at.strftime('%d.%m.%Y') }}</div>
                                                <div class="delivery-date">Дата доставки: {{ order.delivered_at.strftime('%d.%m.%Y') if order.delivered_at else 'Не указана' }}</div>
                                                <pre>{{ order.address }}</pre>
                                                {% if order.delivery_address %}
                                                    <div class="order-address">
                                                        <strong>Адрес доставки:</strong>
                                                        {{ order.delivery_address.street }}, {{ order.delivery_address.city }}
                                                    </div>
                                                {% endif %}



                                        </div>
                                        {% set now = datetime.utcnow() %}
                                        {% set is_delivered = order.delivered_at and order.delivered_at <= now %}
                                        <div class="order-status {{ 'completed' if is_delivered else 'processing' }}">
                                            <span>{{ 'Доставлен' if is_delivered else order.status.capitalize() }}</span>
                                        </div>

                                        <div class="order-price">
                                            {% if order.price %}
                                              <div class="order-price">{{ order.price }} ₽</div>
                                            {% else %}
                                              {% set total_price = 0 %}
                                              {% for item in order.items %}
                                                {% set item_price = item.price or 0 %}
                                                {% set item_qty = item.quantity or 0 %}
                                                {% set total_price = total_price + (item_price * item_qty) %}
                                              {% endfor %}
                                              <div class="order-price">{{ total_price }} ₽</div>
                                            {% endif %}

                                        </div>
                                    </div>

                                    <div class="order-products">
                                        {% for item in order.items %}
                                            {% set item_price = item.price if item.price else (item.product.price if item.product.price else 0) %}
                                            <div class="order-product">
                                                <img src="{% if item.product.photonum %}
                                                              {{ url_for('static', filename='img/products/' ~ item.product.photonum) }}
                                                          {% else %}
                                                              {{ url_for('static', filename='img/products/no-image.jpg') }}
                                                          {% endif %}"
                                                     alt="{{ item.product.name }}">


                                                <div class="product-details">
                                                    <h4>{{ item.product.name }}</h4>
                                                    {% if item.product.desc != 'no' %}
                                                        <p>{{ item.product.desc[:120] }}{% if item.product.desc|length > 120 %}...{% endif %}</p>
                                                    {% endif %}
                                                    <div class="product-qty">Количество: {{ item.quantity }}</div>
                                                    <div class="product-price">
                                                        {{ item.quantity }} × {{ item_price }} ₽ = <strong>{{ item_price * item.quantity }} ₽</strong>
                                                    </div>

                                                </div>
                                            </div>
                                        {% endfor %}

                                    </div>


                                    <div class="order-actions">
                                        <form method="POST" action="{{ url_for('repeat_order', order_id=order.id) }}">
                                            <button type="submit" class="btn-primary">Повторить заказ</button>
                                        </form>
                                    </div>
                                </div>
                            {% else %}
                                <p>У вас пока нет заказов.</p>
                            {% endfor %}
                        </div>

                    </div>
                </div>

                    <!-- Адреса -->
                    <div class="tab-content" id="addresses">
                        <div class="section-card">
                            <div class="section-header">
                                <h3>Мои адреса</h3>
                                <button class="btn-primary" id="add-address-btn" type="button">Добавить адрес</button>

                            </div>
                            <form id="add-address-form" method="POST" action="{{ url_for('add_address') }}" class="hidden">
                                <div class="form-group">
                                    <label for="city">Город</label>
                                    <input type="text" id="city" name="city" required>
                                </div>
                                <div class="form-group">
                                    <label for="street">Улица</label>
                                    <input type="text" id="street" name="street" required>
                                </div>
                                <div class="form-group">
                                    <label for="default">Сделать адрес основным</label>
                                    <input type="checkbox" id="default" name="default" value="1">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary">Сохранить</button>
                                    <button type="button" class="btn-secondary" id="cancel-add-address">Отмена</button>
                                </div>
                            </form>
                            <div class="address-list">
                                {% if addresses %}
                                    <form method="POST" action="{{ url_for('update_default_address') }}">
                                        {% for address in addresses %}
                                            <div class="address-item">
                                                <label>
                                                    <input type="radio" name="default_address" value="{{ address.id }}" {% if address.default %}checked{% endif %}>
                                                    <strong>Дом:</strong> {{ address.street }}, <strong>Город:</strong> {{ address.city }}
                                                </label>
                                                <div class="address-actions">
                                                    <button class="btn-outline" type="button">Редактировать</button>
                                                    <button class="btn-secondary" type="button">Удалить</button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                        <button type="submit" class="btn-primary">Сохранить основной адрес</button>
                                    </form>
                                {% else %}
                                    <p>У вас пока нет сохранённых адресов.</p>
                                {% endif %}
                            </div>


                        </div>
                    </div>

                    <!-- Настройки -->
                    <div class="tab-content" id="settings">
                        <div class="section-card">
                            <div class="section-header">
                                <h3>Настройки уведомлений</h3>
                            </div>
                            <form class="settings-form">
                                <div class="form-group checkbox">
                                    <input type="checkbox" id="promo-emails" checked>
                                    <label for="promo-emails">Получать промо-рассылки на email</label>
                                </div>
                                <div class="form-group checkbox">
                                    <input type="checkbox" id="sms-alerts">
                                    <label for="sms-alerts">Получать SMS-уведомления о заказах</label>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary">Сохранить настройки</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div> <!-- .account-content -->
            </div> <!-- .account-wrapper -->
        </div> <!-- .container -->
    </main>

    {% include 'partials/footer.html' %}


    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="{{ url_for('static', filename='account/account.js') }}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const addAddressBtn = document.getElementById('add-address-btn');
      const addAddressForm = document.getElementById('add-address-form');
      const cancelAddAddressBtn = document.getElementById('cancel-add-address');

      addAddressBtn.addEventListener('click', () => {
        addAddressForm.classList.remove('hidden');
      });

      cancelAddAddressBtn.addEventListener('click', () => {
        addAddressForm.classList.add('hidden');
        addAddressForm.reset();
      });

      addAddressForm.addEventListener('submit', () => {
      });
    });



    </script>
</body>
</html>

