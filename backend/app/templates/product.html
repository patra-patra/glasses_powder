<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} — Очки и Пудра</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='product/product-cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='menu_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='product/product.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/sign.png') }}">
</head>
<body>
    {% include 'header.html' %}

    <main class="product-page">
        <div class="container">
            <!--Основная информация о товаре-->
            <div class="product-main">
                <!--Галерея изображения товара-->
                <div class="product-gallery">
                    <div class="product-main-image">
                        <img src="{{ url_for('static', filename='img/products/' ~ product.photonum) }}" alt="{{ product.name }}" id="main-product-image">

                    </div>
                </div>

                <!--Информация о товаре-->
                <div class="product-info-block">
                    <h1 class="product-title">{{ product.name }}</h1>
                    <div class="product-sku">Артикул: {{ product.id }}</div>

                    <div class="product-price-block">
                        {% if product.old_price %}
                            <div class="product-old-price">{{ product.old_price }} ₽</div>
                            <div class="product-price">{{ product.price }} ₽</div>
                            <div class="product-discount">-{{ product.discount_percent }}%</div>
                        {% else %}
                            <div class="product-price">{{ product.price }} ₽</div>
                        {% endif %}
                    </div>

                    <div class="product-full-description">
                      {% if product.desc and product.desc != "no" and product.desc|length > 10 %}
                        {{ product.desc }}
                      {% else %}
                        Описание отсутствует
                      {% endif %}
                    </div>

                    <!--Кнопки действий-->
                    <div class="product-actions">
                        <form action="{{ url_for('add_to_cart') }}" method="POST" id="main-add-to-cart-form">
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <button type="submit" class="btn btn-primary add-to-cart">
                                <i class="fas fa-shopping-cart"></i> Добавить в корзину
                            </button>
                        </form>
                    </div>

                    <!--Дополнительная информация-->
                    <div class="product-additional-info">
                        <div class="info-item">
                            <i class="fas fa-truck"></i>
                            <span>Бесплатная доставка при заказе от 5000 ₽</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-undo"></i>
                            <span>Возврат в течение 14 дней</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Гарантия 1 год</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="product-tabs">
              <div class="tabs-header">
                <button class="tab-btn active" data-tab="description">Описание</button>
                <button class="tab-btn" data-tab="additional-info">Дополнительная информация</button>
              </div>

              <div class="tabs-content">
                <div class="tab-panel active" id="description">
                  <div class="product-full-description">
                    {{ product.desc if product.desc and product.desc != "no" else "Описание отсутствует" }}
                  </div>
                </div>

                <div class="tab-panel" id="additional-info">
                  {% set field_names = {
                      'types': 'Раздел',
                      'material': 'Материал',
                      'brand': 'Бренд',
                      'country': 'Страна производства',
                      'color': 'Цвет/Оттенок',
                      'massa': 'Вес',
                      'struct': 'Состав',
                      'use': 'Способ применения'
                  } %}
                  <ul class="product-info-list">
                    {% set skip_fields = ['id', 'name', 'price', 'old_price', 'discount_percent', 'desc', 'url', 'photonum'] %}
                    {% for key, value in product.to_dict().items() %}
                      {% if key not in skip_fields and value and value != "no" %}
                        <li><strong>{{ field_names[key] if key in field_names else key|capitalize }}:</strong> {{ value }}</li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>

            <!--Рекомендуемые товары-->
            <div class="recommended-products">
                <div class="section-header">
                    <h2>Вам также может понравиться</h2>
                </div>

                <div class="product-slider">
                    {% for rec in recommended %}
                    <div class="product-card" data-category="{{ rec.types }}">
                        <a href="{{ url_for('product_page', product_id=rec.id) }}" class="product-card-link">
                            <div class="product-image">
                                <img src="{{ url_for('static', filename='img/products/' ~ rec.photonum) }}" alt="{{ rec.name }}">
                                {% if rec.discount_percent %}
                                <div class="product-badges">
                                    <span class="product-badge">Скидка {{ rec.discount_percent }}%</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="product-info">
                                <h3>{{ rec.name }}</h3>

                                {% if rec.desc != 'no' %}
                                    <p>{{ rec.desc[:120] }}{% if rec.desc|length > 120 %}...{% endif %}</p>
                                {% endif %}

                            <div class="product-bottom">
                                <div class="product-price">{{ rec.price }} ₽</div>
                                <form action="{{ url_for('add_to_cart') }}" method="POST" class="add-to-cart-form">
                                    <input type="hidden" name="product_id" value="{{ rec.id }}">
                                    <button type="submit" class="btn-primary add-to-cart">В корзину</button>
                                </form>
                            </div>

                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </main>

    {% include 'partials/footer.html' %}

    <script>
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

          button.classList.add('active');
          document.getElementById(button.getAttribute('data-tab')).classList.add('active');
        });
      });
    </script>
    <script>
          document.addEventListener('DOMContentLoaded', function() {
        const thumbnails = document.querySelectorAll('.thumbnail');
        const mainImage = document.getElementById('main-product-image');

        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function() {
                thumbnails.forEach(item => item.classList.remove('active'));

                this.classList.add('active');

                const imageUrl = this.getAttribute('data-image');
                mainImage.src = imageUrl;
            });
        });

        const minusBtn = document.querySelector('.quantity-btn.minus');
        const plusBtn = document.querySelector('.quantity-btn.plus');
        const quantityInput = document.querySelector('.quantity-input');

        minusBtn.addEventListener('click', function() {
            let currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        });

        plusBtn.addEventListener('click', function() {
            let currentValue = parseInt(quantityInput.value);
            if (currentValue < 10) {
                quantityInput.value = currentValue + 1;
            }
        });

        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanels.forEach(panel => panel.classList.remove('active'));

                this.classList.add('active');

                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        const addToCartBtn = document.querySelector('.add-to-cart');

        addToCartBtn.addEventListener('click', function() {
            const productName = document.querySelector('.product-title').textContent;
            const productPrice = document.querySelector('.product-price').textContent;
            const productQuantity = quantityInput.value;
            const productColor = document.querySelector('input[name="color"]:checked').value;
            const productSize = document.querySelector('input[name="size"]:checked').value;

            console.log('Товар добавлен в корзину:', {
                name: productName,
                price: productPrice,
                quantity: productQuantity,
                color: productColor,
                size: productSize
            });

            alert('Товар добавлен в корзину!');
        });

        const wishlistBtn = document.querySelector('.wishlist');

        wishlistBtn.addEventListener('click', function() {
            const icon = this.querySelector('i');

            if (icon.classList.contains('far')) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                this.style.color = 'var(--primary-color)';
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                this.style.color = 'var(--text-light)';
            }
        });
    });
    button.addEventListener('click', () => {
        const productId = button.getAttribute('data-product-id');
        if (!productId) {
            alert('Ошибка: product_id не задан');
            return;
        }
    });
    </script>

    <script>
    document.querySelectorAll('.btn-add-to-cart').forEach(button => {
        button.addEventListener('click', () => {
            const form = button.closest('.add-to-cart-form');
            const productId = form.dataset.productId;

            fetch('{{ url_for("add_to_cart") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({ product_id: productId })
            }).then(response => {
                if (response.ok) {
                    alert('Товар добавлен в корзину!');
                } else {
                    alert('Ошибка при добавлении товара');
                }
            });
        });
    });

    document.querySelectorAll('.btn-add-to-cart').forEach(button => {
        button.addEventListener('click', event => {
            event.preventDefault();
            const form = button.closest('.add-to-cart-form');
            const productId = form.dataset.productId;

            if (!productId) {
                alert('Ошибка: product_id не задан');
                return;
            }

            fetch('{{ url_for("add_to_cart") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({ product_id: productId })
            })
            .then(response => {
                if (response.ok) {
                    alert('Товар добавлен в корзину!');
                } else {
                    alert('Ошибка при добавлении товара');
                }
            });
        });
    });

    </script>
</body>
</html>